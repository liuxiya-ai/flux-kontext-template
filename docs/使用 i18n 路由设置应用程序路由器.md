# 使用 `next-intl` 设置 App Router 的国际化 (i18n) 路由

为了给您的应用支持的每种语言使用唯一的路径名，`next-intl` 可用于处理以下路由设置：

  * **基于前缀的路由** (例如 `/en/about`)
  * **基于域的路由** (例如 `en.example.com/about`)

无论哪种情况，`next-intl` 都通过使用一个顶级的动态段 `[locale]` 来与 Next.js 的 App Router 集成，从而提供不同语言的内容。

## 开始

### 1\. 安装

如果您尚未这样做，请先创建一个使用 App Router 的 Next.js 应用，然后在项目终端中运行：

```bash
npm install next-intl
```

### 2\. 创建文件结构

现在，我们将创建以下文件结构。如果要迁移现有应用，通常会在设置过程中将现有页面移动到 `[locale]` 文件夹中。

```plaintext
├── messages
│   ├── en.json
│   └── ...
├── next.config.ts
└── src
    ├── i18n
    │   ├── routing.ts
    │   ├── navigation.ts
    │   └── request.ts
    ├── middleware.ts
    └── app
        └── [locale]
            ├── layout.tsx
            └── page.tsx
```

### 3\. 设置文件

#### `messages/en.json`

消息（Messages）表示每种语言可用的翻译，可以在本地提供或从远程数据源加载。最简单的选项是在本地项目文件夹中添加 JSON 文件：

```json:messages/en.json
{
  "HomePage": {
    "title": "Hello world!",
    "about": "Go to the about page"
  }
}
```

#### `next.config.ts`

现在，设置一个插件，该插件创建一个别名，以提供特定于请求的 i18n 配置，例如您向服务器组件发送的消息。

```typescript:next.config.ts
import {NextConfig} from 'next';
import createNextIntlPlugin from 'next-intl/plugin';
 
const nextConfig: NextConfig = {};
 
const withNextIntl = createNextIntlPlugin();
export default withNextIntl(nextConfig);
```

#### `src/i18n/routing.ts`

我们将在两个地方与Next.js的路由集成：

1.  **中间件 (Middleware)**：协商语言环境并处理重定向和重写。
2.  **导航 API (Navigation APIs)**：围绕Next.js导航 API（例如 `<Link />`）的轻量级包装器。

这使您能够使用诸如 `/about` 的路径名，而语言前缀等 i18n 方面是在后台处理的。为了在这两个地方之间共享配置，我们将设置 `routing.ts`。

```typescript:src/i18n/routing.ts
import {defineRouting} from 'next-intl/routing';
 
export const routing = defineRouting({
  // A list of all locales that are supported
  locales: ['en', 'de'],
 
  // Used when no locale matches
  defaultLocale: 'en'
});
```

#### `src/i18n/navigation.ts`

一旦我们有了路由配置，就可以使用它来设置导航 API。

```typescript:src/i18n/navigation.ts
import {createNavigation} from 'next-intl/navigation';
import {routing} from './routing';
 
// Lightweight wrappers around Next.js' navigation
// APIs that consider the routing configuration
export const {Link, redirect, usePathname, useRouter, getPathname} =
  createNavigation(routing);
```

#### `src/middleware.ts`

此外，我们可以使用路由配置来设置中间件。

```typescript:src/middleware.ts
import createMiddleware from 'next-intl/middleware';
import {routing} from './i18n/routing';
 
export default createMiddleware(routing);
 
export const config = {
  // Match all pathnames except for
  // - … if they start with `/api`, `/trpc`, `/_next` or `/_vercel`
  // - … the ones containing a dot (e.g. `favicon.ico`)
  matcher: '/((?!api|trpc|_next|_vercel|.*\\..*).*)'
};
```

#### `src/i18n/request.ts`

使用服务器组件中的 `next-intl` 功能时，相关配置将从约定位于 `i18n/request.ts` 的中央模块读取。此配置的范围限定为当前请求，可用于根据用户的区域设置提供消息和其他选项。

```typescript:src/i18n/request.ts
import {getRequestConfig} from 'next-intl/server';
import {hasLocale} from 'next-intl';
import {routing} from './routing';
 
export default getRequestConfig(async ({requestLocale}) => {
  // Typically corresponds to the `[locale]` segment
  const requested = await requestLocale;
  const locale = hasLocale(routing.locales, requested)
    ? requested
    : routing.defaultLocale;
 
  return {
    locale,
    messages: (await import(`../../messages/${locale}.json`)).default
  };
});
```

#### `src/app/[locale]/layout.tsx`

由中间件匹配的 `locale` 可通过 `params` 参数获得，可用于配置文档语言。此外，我们可以使用这个地方通过 `NextIntlClientProvider` 将配置从 `i18n/request.ts` 传递给客户端组件。

```tsx:src/app/[locale]/layout.tsx
import {NextIntlClientProvider, hasLocale} from 'next-intl';
import {notFound} from 'next/navigation';
import {routing} from '@/i18n/routing';
 
export default async function LocaleLayout({
  children,
  params
}: {
  children: React.ReactNode;
  params: Promise<{locale: string}>;
}) {
  // Ensure that the incoming `locale` is valid
  const {locale} = await params;
  if (!hasLocale(routing.locales, locale)) {
    notFound();
  }
 
  return (
    <html lang={locale}>
      <body>
        <NextIntlClientProvider>{children}</NextIntlClientProvider>
      </body>
    </html>
  );
}
```

#### `src/app/[locale]/page.tsx`

现在，您可以在组件中使用 `next-intl` 的翻译和其他功能。

**对于客户端组件或混合组件：**

```tsx:src/app/[locale]/page.tsx
import {useTranslations} from 'next-intl';
import {Link} from '@/i18n/navigation';
 
export default function HomePage() {
  const t = useTranslations('HomePage');
  return (
    <div>
      <h1>{t('title')}</h1>
      <Link href="/about">{t('about')}</Link>
    </div>
  );
}
```

**对于纯服务器（异步）组件：**

```tsx:src/app/[locale]/page.tsx
import {getTranslations} from 'next-intl/server';
 
export default async function HomePage() {
  const t = await getTranslations('HomePage');
  return <h1>{t('title')}</h1>;
}
```

仅此而已！如果您遇到问题，请查看官方的 App Router 示例以探索有效的应用程序。

## 后续步骤

  * **使用指南**：了解如何设置消息格式、日期和时间。
  * **路由**：设置本地化路径名、基于域的路由等。
  * **工作流程**：与 TypeScript 等工具深度集成。

## 静态渲染 (Static Rendering)

当 `next-intl` 与 i18n 路由一起使用时，在服务器组件中使用 `useTranslations` 等API时，默认会进入动态渲染。以下是启用静态渲染的临时API。

### 添加 `generateStaticParams`

由于我们对 `[locale]` 使用了动态路由段，因此我们需要通过 `generateStaticParams` 将所有可能的值传递给Next.js，以便在构建时渲染路由。

您可以将 `generateStaticParams` 添加到布局或页面：

  * **布局** (例如 `app/[locale]/layout.tsx`): 为此布局中的所有页面启用静态渲染。
  * **单个页面** (例如 `app/[locale]/page.tsx`): 为特定页面启用静态渲染。

**示例:**

```typescript
import {routing} from '@/i18n/routing';
 
export function generateStaticParams() {
  return routing.locales.map((locale) => ({locale}));
}
```

### 添加到所有相关布局和页面 `setRequestLocale`

`next-intl` 提供了一个 API，可用于分发通过 `params` 接收的 `locale`，以便在作为请求的一部分呈现的所有服务器组件中使用。

**示例 (`app/[locale]/layout.tsx`):**

```tsx
import {setRequestLocale} from 'next-intl/server';
// ... other imports
 
export default async function LocaleLayout({children, params}) {
  const {locale} = await params;
  if (!hasLocale(routing.locales, locale)) {
    notFound();
  }
 
  // Enable static rendering
  setRequestLocale(locale);
 
  return (
    // ...
  );
}
```

**示例 (`app/[locale]/page.tsx`):**

```tsx
import {use} from 'react';
import {setRequestLocale} from 'next-intl/server';
// ... other imports
 
export default function IndexPage({params}) {
  const {locale} = use(params);
 
  // Enable static rendering
  setRequestLocale(locale);
 
  const t = useTranslations('IndexPage');
 
  return (
    // ...
  );
}
```

> **请记住**:
>
>   * 应验证您传递给 `setRequestLocale` 的 `locale`。
>   * 您需要在要为其启用静态渲染的每个页面和每个布局中调用此函数。

### 在元数据中使用 `locale` 参数

除了页面的呈现之外，页面元数据也需要符合静态呈现的条件。为此，您可以将从 `params` 收到的 `locale` 转发到 `next-intl` 的可等待函数。

```typescript:page.tsx
import {getTranslations} from 'next-intl/server';
 
export async function generateMetadata({params}) {
  const {locale} = await params;
  const t = await getTranslations({locale, namespace: 'Metadata'});
 
  return {
    title: t('title')
  };
}
```